"use strict";(self.webpackChunk=self.webpackChunk||[]).push([["components_top-matter_MapSplitMatter_vue"],{40324:(t,e,o)=>{o.d(e,{A:()=>i});var r=o(34942),n=o.n(r),a=o(60278),s=o.n(a)()(n());s.push([t.id,".map-matter[data-v-58f64320]{height:100%;width:100%}.map[data-v-58f64320]{height:100%;width:100%;margin:0;z-index:0;background-color:var(--color-background-dark)}.map[data-v-58f64320] .leaflet-control-attribution{background-color:var(--color-background-dark);color:var(--color-text-light)}.map[data-v-58f64320] .leaflet-bar a{background-color:var(--color-main-background);color:var(--color-main-text)}.map[data-v-58f64320] .leaflet-bar a.leaflet-disabled{opacity:.6}.preview[data-v-58f64320]{width:48px;height:48px;background-color:rgba(0,0,0,.3);border-radius:5px;position:relative;box-shadow:0 0 3px rgba(0,0,0,.2)}.preview[data-v-58f64320]:hover{box-shadow:0 0 3px var(--color-primary)}.preview img[data-v-58f64320]{width:100%;height:100%;object-fit:cover;border-radius:5px;cursor:pointer}.preview .count[data-v-58f64320]{background-color:var(--color-primary);color:var(--color-primary-text);padding:0 4px;border-radius:5px;font-size:.8em}","",{version:3,sources:["webpack://./components/top-matter/MapSplitMatter.vue"],names:[],mappings:"AACA,6BACE,WAAA,CACA,UAAA,CAGF,sBACE,WAAA,CACA,UAAA,CACA,QAAA,CACA,SAAA,CACA,6CAAA,CAEA,mDACE,6CAAA,CACA,6BAAA,CAGF,qCACE,6CAAA,CACA,4BAAA,CAEA,sDACE,UAAA,CAKN,0BACE,UAAA,CACA,WAAA,CACA,+BAAA,CACA,iBAAA,CACA,iBAAA,CACA,iCAAA,CAEA,gCACE,uCAAA,CAGF,8BACE,UAAA,CACA,WAAA,CACA,gBAAA,CACA,iBAAA,CACA,cAAA,CAGF,iCACE,qCAAA,CACA,+BAAA,CACA,aAAA,CACA,iBAAA,CACA,cAAA",sourcesContent:["\n.map-matter {\n  height: 100%;\n  width: 100%;\n}\n\n.map {\n  height: 100%;\n  width: 100%;\n  margin: 0;\n  z-index: 0;\n  background-color: var(--color-background-dark);\n\n  :deep .leaflet-control-attribution {\n    background-color: var(--color-background-dark);\n    color: var(--color-text-light);\n  }\n\n  :deep .leaflet-bar a {\n    background-color: var(--color-main-background);\n    color: var(--color-main-text);\n\n    &.leaflet-disabled {\n      opacity: 0.6;\n    }\n  }\n}\n\n.preview {\n  width: 48px;\n  height: 48px;\n  background-color: rgba(0, 0, 0, 0.3);\n  border-radius: 5px;\n  position: relative;\n  box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);\n\n  &:hover {\n    box-shadow: 0 0 3px var(--color-primary);\n  }\n\n  img {\n    width: 100%;\n    height: 100%;\n    object-fit: cover;\n    border-radius: 5px;\n    cursor: pointer;\n  }\n\n  .count {\n    background-color: var(--color-primary);\n    color: var(--color-primary-text);\n    padding: 0 4px;\n    border-radius: 5px;\n    font-size: 0.8em;\n  }\n}\n"],sourceRoot:""}]);const i=s},95220:(t,e,o)=>{o.d(e,{A:()=>i});var r=o(34942),n=o.n(r),a=o(60278),s=o.n(a)()(n());s.push([t.id,".anim-markers .leaflet-marker-icon{transition:transform .3s ease}.leaflet-marker-icon.dummy{z-index:-100000 !important}.leaflet-marker-icon:hover{z-index:100000 !important}","",{version:3,sources:["webpack://./components/top-matter/MapSplitMatter.vue"],names:[],mappings:"AAEE,mCACE,6BAAA,CAGF,2BACE,0BAAA,CAGF,2BACE,yBAAA",sourcesContent:["\n.leaflet-marker-icon {\n  .anim-markers & {\n    transition: transform 0.3s ease;\n  }\n\n  &.dummy {\n    z-index: -100000 !important;\n  }\n\n  &:hover {\n    z-index: 100000 !important;\n  }\n}\n"],sourceRoot:""}]);const i=s},50397:(t,e,o)=>{o.r(e),o.d(e,{default:()=>$});var r=o(27507),n=o(20127),a=o(63628),s=o(82483),i=o(71175),c=o(40152),A=o(96541),l=o(55437),m=o(62741),u=o(16767);o(3250),o(16561);delete A.Icon.Default.prototype._getIconUrl,A.Icon.Default.mergeOptions({iconRetinaUrl:o(56955),iconUrl:o(39298),shadowUrl:o(53697)});const d=(0,r.pM)({name:"MapSplitMatter",components:{LMap:n.A,LTileLayer:a.A,LMarker:s.A,LPopup:i.A,LIcon:c.A},data:()=>({zoom:2,oldZoom:2,mapOptions:{maxBounds:(0,A.latLngBounds)([-90,-180],[90,180]),maxBoundsViscosity:.9},clusters:[],animMarkers:!1}),mounted(){this.refs.map.mapObject.zoomControl.setPosition("topright"),this.initialize()},created(){u.bus.on("memories:window:resize",this.handleContainerResize)},beforeDestroy(){u.bus.off("memories:window:resize",this.handleContainerResize)},computed:{refs(){return this.$refs},tileurl:()=>"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:()=>'&copy; <a target="_blank" href="http://osm.org/copyright">OpenStreetMap</a> contributors'},watch:{$route(t,e){t.query.b===e.query.b&&t.query.z===e.query.z||this.initialize(!0)}},methods:{async initialize(t=!1){var e;if(this.$route.query.b&&this.$route.query.z)return t||this.setBoundsFromQuery(),await this.fetchClusters();try{const t=await l.A.get(m.n.MAP_INIT()),o=this.refs.map,r=null===(e=null==t?void 0:t.data)||void 0===e?void 0:e.pos;if(!(null==r?void 0:r.lat)||!(null==r?void 0:r.lon))throw new Error("No position data");o.mapObject.setView([r.lat,r.lon],11)}catch(t){}finally{this.refresh()}},async refreshDebounced(){u.setRenewingTimeout(this,"refreshTimer",this.refresh,250)},async refresh(){const t=this.refs.map;if(!t||!t.mapObject)return;const e=t.mapObject.getBounds();let o=e.getSouth(),r=e.getNorth(),n=e.getWest(),a=e.getEast();const s=this.boundsToStr({minLat:o,maxLat:r,minLon:n,maxLon:a});this.zoom=Math.round(t.mapObject.getZoom());const i={b:s,z:this.zoom.toString()};this.$route.query.b===i.b&&this.$route.query.z===i.z||this.$router.replace({query:i,hash:this.$route.hash})},async fetchClusters(){const t=this.oldZoom,e=this.$route.query.b,o=this.$route.query.z;let{minLat:r,maxLat:n,minLon:a,maxLon:s}=this.boundsFromQuery();const i=Math.abs(n-r),c=Math.abs(s-a);r-=.25*i,n+=.25*i,a-=.25*c,s+=.25*c;const A=this.boundsToStr({minLat:r,maxLat:n,minLon:a,maxLon:s}),u=m.n.Q(m.n.MAP_CLUSTERS(),{bounds:A,zoom:o}),d=await l.A.get(u);(()=>this.$route.query.b!==e||this.$route.query.z!==o)()||(this.oldZoom=this.zoom,this.zoom>t?this.setClustersZoomIn(d.data,t):this.zoom<t?this.setClustersZoomOut(d.data):this.clusters=d.data,this.animateMarkers())},boundsFromQuery(){const t=this.$route.query.b.split(",");return{minLat:parseFloat(t[0]),maxLat:parseFloat(t[1]),minLon:parseFloat(t[2]),maxLon:parseFloat(t[3])}},boundsToStr({minLat:t,maxLat:e,minLon:o,maxLon:r}){const n=t=>t.toFixed(6);return`${n(t)},${n(e)},${n(o)},${n(r)}`},setBoundsFromQuery(){const t=this.refs.map,{minLat:e,maxLat:o,minLon:r,maxLon:n}=this.boundsFromQuery();t.mapObject.fitBounds([[e,r],[o,n]])},clusterPreviewUrl:t=>u.getPreviewUrl({photo:t.preview,msize:256}),clusterIconClass:t=>t.dummy?"dummy":"",zoomTo(t){if(this.zoom>=12&&t.preview)return t.preview.key=t.preview.fileid.toString(),void _m.viewer.open(t.preview);const e=this.refs.map,o=globalThis.innerWidth>=768?2:1,r=e.mapObject.getZoom()+o;e.mapObject.setView(t.center,r,{animate:!0})},getGridKey(t,e){const o=180/(2**e*1);return`${Math.floor(t[0]/o)}-${Math.floor(t[1]/o)}`},getGridMap(t,e){const o=new Map;for(const r of t){const t=this.getGridKey(r.center,e);o.set(t,r)}return o},async setClustersZoomIn(t,e){const o=this.getGridMap(this.clusters,e),r=[];for(const n of t){const t=this.getGridKey(n.center,e),a=o.get(t);a?r.push(Object.assign(Object.assign({},n),{center:a.center})):r.push(n)}this.clusters=r,await this.$nextTick(),await new Promise((t=>setTimeout(t,0))),this.clusters=t},async setClustersZoomOut(t){const e=this.getGridMap(t,this.zoom),o=new Map;for(const e of t)o.set(e.id,e);const r=[...t];for(const t of this.clusters){if(!o.get(t.id)){const o=this.getGridKey(t.center,this.zoom),n=e.get(o);n&&(t.center=n.center,t.dummy=!0,r.push(t))}}this.clusters=r,await new Promise((t=>setTimeout(t,300))),this.clusters=t},async animateMarkers(){this.animMarkers=!0,await new Promise((t=>setTimeout(t,300))),this.animMarkers=!1},handleContainerResize(){var t,e;null===(e=null===(t=this.refs.map)||void 0===t?void 0:t.mapObject)||void 0===e||e.invalidateSize(!0)}}});var p=o(95292),h=o.n(p),C=o(49893),b=o.n(C),f=o(9383),g=o.n(f),v=o(56884),y=o.n(v),w=o(99088),x=o.n(w),k=o(27997),z=o.n(k),L=o(40324),M={};M.styleTagTransform=z(),M.setAttributes=y(),M.insert=g().bind(null,"head"),M.domAPI=b(),M.insertStyleElement=x();h()(L.A,M);L.A&&L.A.locals&&L.A.locals;var B=o(95220),E={};E.styleTagTransform=z(),E.setAttributes=y(),E.insert=g().bind(null,"head"),E.domAPI=b(),E.insertStyleElement=x();h()(B.A,E);B.A&&B.A.locals&&B.A.locals;const $=(0,o(67658).A)(d,(function(){var t=this,e=t._self._c;t._self._setupProxy;return e("div",{class:{"map-matter":!0,"anim-markers":t.animMarkers}},[e("LMap",{ref:"map",staticClass:"map",attrs:{crossOrigin:!0,zoom:t.zoom,minZoom:2,options:t.mapOptions},on:{moveend:t.refreshDebounced,zoomend:t.refreshDebounced}},[e("LTileLayer",{attrs:{url:t.tileurl,attribution:t.attribution,noWrap:!0}}),t._v(" "),t._l(t.clusters,(function(o){return e("LMarker",{key:o.id,attrs:{"lat-lng":o.center},on:{click:function(e){return t.zoomTo(o)}}},[e("LIcon",{attrs:{"icon-anchor":[24,24],className:t.clusterIconClass(o)}},[e("div",{staticClass:"preview"},[o.count>1?e("div",{staticClass:"count top-left"},[t._v("\n            "+t._s(o.count)+"\n          ")]):t._e(),t._v(" "),t._o(e("XImg",{class:["thumb-important",`memories-thumb-${o.preview.fileid}`],attrs:{src:t.clusterPreviewUrl(o)}}),0,o.id)],1)])],1)}))],2)],1)}),[],!1,null,"58f64320",null).exports}}]);
//# sourceMappingURL=memories-components_top-matter_MapSplitMatter_vue.js.map?v=33992dc7ceb1683e4312