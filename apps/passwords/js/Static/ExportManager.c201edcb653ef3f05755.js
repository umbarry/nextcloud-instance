"use strict";(self.webpackChunkncpasswords=self.webpackChunkncpasswords||[]).push([[6918],{87259:(e,t,r)=>{r.r(t),r.d(t,{ExportManager:()=>d});var a=r(71710),o=r.n(a),s=r(56423),i=r(90512),n=r(34413),l=r(80444);class d{constructor(){this.defaultFolder="00000000-0000-0000-0000-000000000000"}async exportDatabase(e="json",t=null,r={}){null===t&&(t=["passwords","folders","tags"]);let a="";switch(e){case"json":a=await d.exportJson(t,r);break;case"csv":a=await this.exportCsv(t,r.includeShared);break;case"customCsv":a=await this.exportCustomCsv(r);break;case"xlsx":a=await this.exportOfficeDocument(t,r.includeShared,"xlsx");break;case"ods":a=await this.exportOfficeDocument(t,r.includeShared,"ods");break;default:throw new Error(`Invalid export format: ${e}`)}return a}static async exportJson(e,t){let r={version:3,encrypted:!1};if(-1!==e.indexOf("passwords")&&(r.passwords=await d._getPasswordsForExport(t.includeShared)),-1!==e.indexOf("folders")&&(r.folders=await d._getFoldersForExport()),-1!==e.indexOf("tags")&&(r.tags=await d._getTagsForExport()),t.password){for(let e in r){if(!r.hasOwnProperty(e)||-1!==["version","encrypted"].indexOf(e))continue;let a=JSON.stringify(r[e]),o=t.password+e;r[e]=await n.A.getClient().getInstance("encryption.expv1").encrypt(a,o)}r.encrypted=!0,r.challenge=await n.A.getClient().getInstance("encryption.expv1").encrypt("challenge",`${t.password}challenge`)}return JSON.stringify(r)}async exportCsv(e=[],t=!1){let r={};if(-1!==e.indexOf("passwords")){let e=await d._getPasswordsForExport(t),a=["label","username","password","notes","url","customFields","folderLabel","tagLabels","favorite","edited","id","revision","folderId"];e=await this._convertDbToExportArray(e,a.clone()),r.passwords=d._createCsvExport(e,a)}if(-1!==e.indexOf("folders")){let e=await d._getFoldersForExport(),t=["label","parentLabel","favorite","edited","id","revision","parentId"];e=await this._convertDbToExportArray(e,t.clone()),r.folders=d._createCsvExport(e,t)}if(-1!==e.indexOf("tags")){let e=await d._getTagsForExport(),t=["label","color","favorite","edited","id","revision"];e=await this._convertDbToExportArray(e,t.clone()),r.tags=d._createCsvExport(e,t)}if(1===e.length)return r[e[0]];let a=new(o());for(let e in r)r.hasOwnProperty(e)&&a.file(`${e.capitalize()}.csv`,r[e]);return await a.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}})}async exportCustomCsv(e){let t,r=[];return"passwords"===e.db?t=await d._getPasswordsForExport(e.includeShared):"folders"===e.db?t=await d._getFoldersForExport():"tags"===e.db&&(t=await d._getTagsForExport()),e.header&&(r=i.A.cloneObject(e.mapping)),t=await this._convertDbToExportArray(t,e.mapping),d._createCsvExport(t,r,e.delimiter)}async exportOfficeDocument(e=[],t=!1,a){let o={};if(-1!==e.indexOf("passwords")){let e=await d._getPasswordsForExport(t),r=["label","username","password","notes","url","customFields","folderLabel","tagLabels","favorite","edited","id","revision","folderId"];e=await this._convertDbToExportArray(e,r.clone()),o.passwords=d._convertOfficeExport(e,r)}if(-1!==e.indexOf("folders")){let e=await d._getFoldersForExport(),t=["label","parentLabel","favorite","edited","id","revision","parentId"];e=await this._convertDbToExportArray(e,t.clone()),o.folders=d._convertOfficeExport(e,t)}if(-1!==e.indexOf("tags")){let e=await d._getTagsForExport(),t=["label","color","favorite","edited","id","revision"];e=await this._convertDbToExportArray(e,t.clone()),o.tags=d._convertOfficeExport(e,t)}try{let e=await r.e(1102).then(r.bind(r,3959)),t={SheetNames:[],Sheets:{}};for(let r in o){if(!o.hasOwnProperty(r))continue;let a=l.A.translate(r.capitalize());t.SheetNames.push(a),t.Sheets[a]=e.utils.aoa_to_sheet(o[r],{cellDates:!0})}return e.write(t,{bookType:a,type:"array"})}catch(e){throw new Error(l.A.translate("Unable to load {module}",{module:"xlsx"}))}}async _convertDbToExportArray(e,t){let r=await this._createExportFolderMapping(t),a=await d._createExportTagMapping(t),o=[];-1!==t.indexOf("folderId")&&(t[t.indexOf("folderId")]="folder"),-1!==t.indexOf("parentId")&&(t[t.indexOf("parentId")]="parent"),-1!==t.indexOf("tagIds")&&(t[t.indexOf("tagIds")]="tags");for(let s in e){if(!e.hasOwnProperty(s))continue;let i=d._convertObjectToExportArray(e[s],t,r,a);o.push(i)}return o}async _createExportFolderMapping(e){let t={};if(-1!==e.indexOf("folderLabel")||-1!==e.indexOf("parentLabel")){let e=await s.A.listFolders();t[this.defaultFolder]=l.A.translate("Home");for(let r in e)e.hasOwnProperty(r)&&(t[e[r].id]=e[r].label)}return t}static async _createExportTagMapping(e){let t={};if(-1!==e.indexOf("tagLabels")){let e=await s.A.listTags();for(let r in e)e.hasOwnProperty(r)&&(t[e[r].id]=e[r].label)}return t}static _convertObjectToExportArray(e,t,r,a){let o=[];for(let s=0;s<t.length;s++){let i=t[s];"folderLabel"===i?o.push(r.hasOwnProperty(e.folder)?r[e.folder]:""):"parentLabel"===i?o.push(r.hasOwnProperty(e.parent)?r[e.parent]:""):"tagLabels"===i?o.push(d._convertTagLabelsForExport(e,a)):"customFields"===i?this._convertCustomFieldsForExport(e,i,o):-1!==["edited","updated","created"].indexOf(i)?o.push(new Date(1e3*e[i])):"empty"===i?o.push(""):o.push(e[i])}return o}static _convertCustomFieldsForExport(e,t,r){let a=e[t],o=[];for(let e=0;e<a.length;e++){let t=a[e];if(!t.hasOwnProperty("value"))continue;let r=t.value.toString().replace(/(\r\n|\n|\r)/gm," ");o.push(`${t.label}, ${t.type}: ${r}`)}r.push(o.join("\n"))}static _convertTagLabelsForExport(e,t){let r=[];for(let a in e.tags)e.tags.hasOwnProperty(a)&&r.push(t[e.tags[a]]);return r}static _createCsvExport(e,t=[],r=","){let a=[];if(t&&0!==t.length){let e=[];for(let r=0;r<t.length;r++)e.push(`"${l.A.translate(t[r].capitalize()).replace('"','""')}"`);a.push(e.join(r))}for(let t=0;t<e.length;t++){let o=e[t],s=[];for(let e=0;e<o.length;e++){let t=o[e];"boolean"==typeof t&&(t=l.A.translate(t.toString())),s.push(`"${t.toString().replace(/"/g,'""')}"`)}a.push(s.join(r))}return a.join("\n")}static _convertOfficeExport(e,t=[]){let r=[];if(t&&0!==t.length){let e=[];for(let r=0;r<t.length;r++)e.push(l.A.translate(t[r].capitalize()));r.push(e)}for(let t=0;t<e.length;t++){let a=e[t],o=[];for(let e=0;e<a.length;e++){let t=a[e];t instanceof Date||"boolean"==typeof t?o.push(t):o.push(t.toString())}r.push(o)}return r}static async _getPasswordsForExport(e=!1){let t=await s.A.listPasswords("model+tags"),r=[];for(let a in t){if(!t.hasOwnProperty(a))continue;if(e&&null!==t[a].share)continue;let o=t[a],s={id:o.id,revision:o.revision,label:o.label,username:o.username,password:o.password,notes:o.notes,url:o.url,customFields:o.customFields,folder:o.folder,edited:Math.floor(o.edited.getTime()/1e3),favorite:o.favorite,tags:[]};for(let e in o.tags)o.tags.hasOwnProperty(e)&&s.tags.push(o.tags[e].id);r.push(s)}return r}static async _getFoldersForExport(){let e=await s.A.listFolders(),t=[];for(let r in e){if(!e.hasOwnProperty(r))continue;let a=e[r];t.push({id:a.id,revision:a.revision,label:a.label,parent:a.parent,edited:Math.floor(a.edited.getTime()/1e3),favorite:a.favorite})}return t}static async _getTagsForExport(){let e=await s.A.listTags(),t=[];for(let r in e){if(!e.hasOwnProperty(r))continue;let a=e[r];t.push({id:a.id,revision:a.revision,label:a.label,color:a.color,edited:Math.floor(a.edited.getTime()/1e3),favorite:a.favorite})}return t}}}}]);